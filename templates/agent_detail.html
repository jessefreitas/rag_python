<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ agent.name }} - Detalhes do Agente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: border-color 0.3s;
            background-color: #f8f9fa;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background-color: white;
        }
        .file-item:hover {
            background-color: #f8f9fa;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.user {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.agent {
            background-color: #e9ecef;
            color: #212529;
            margin-right: auto;
        }
        .agent-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>Sistema de Agentes RAG
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="/agents">
                    <i class="fas fa-cogs me-1"></i>Agentes
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header do Agente -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card agent-info">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h1 class="display-6 mb-2">{{ agent.name }}</h1>
                                <p class="lead mb-3">{{ agent.description }}</p>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-light text-dark">
                                        <i class="fas fa-file me-1"></i>{{ agent.document_count }} documentos
                                    </span>
                                    <span class="badge bg-light text-dark">{{ agent.model_name }}</span>
                                    <span class="badge bg-light text-dark">Temp: {{ agent.temperature }}</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-light btn-lg" onclick="startChat()">
                                    <i class="fas fa-comments me-2"></i>Chat com Agente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="row">
            <!-- Upload de Arquivos -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>Upload de Documentos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h6>Arraste arquivos aqui ou clique para selecionar</h6>
                            <p class="text-muted">Suporta: PDF, DOCX, TXT, DOC, PPTX, XLSX</p>
                            <input type="file" id="fileInput" multiple accept=".pdf,.docx,.txt,.doc,.pptx,.xlsx" style="display: none;">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open me-1"></i>Selecionar Arquivos
                            </button>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="progress mt-3" id="uploadProgress" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <!-- Lista de Arquivos -->
                        <div class="mt-4">
                            <h6><i class="fas fa-files-o me-2"></i>Documentos do Agente</h6>
                            <div id="filesList">
                                {% if files %}
                                    {% for file in files %}
                                    <div class="file-item">
                                        <div>
                                            <i class="fas fa-file me-2"></i>
                                            <strong>{{ file.name }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                {{ (file.size / 1024)|round(1) }} KB • 
                                                {{ file.modified[:10] }}
                                            </small>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('{{ file.name }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-4 text-muted">
                                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                                        <p>Nenhum documento carregado</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat com Agente -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>Chat com {{ agent.name }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chat-container" id="chatContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-robot fa-2x mb-2"></i>
                                <p>Inicie uma conversa com {{ agent.name }}</p>
                                <small>O agente responderá baseado nos documentos carregados</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="Digite sua pergunta...">
                                <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informações do Agente -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Configurações do Agente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Prompt do Sistema</h6>
                                <div class="bg-light p-3 rounded">
                                    <p class="mb-0">{{ agent.system_prompt }}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Configurações Técnicas</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Modelo:</strong> {{ agent.model_name }}</li>
                                    <li><strong>Temperatura:</strong> {{ agent.temperature }}</li>
                                    <li><strong>Máx. Iterações:</strong> {{ agent.max_iterations }}</li>
                                    <li><strong>Memória:</strong> {{ "Ativada" if agent.memory else "Desativada" }}</li>
                                    <li><strong>Ferramentas:</strong> {{ agent.tools|join(", ") }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const agentId = '{{ agent.id }}';
        let isUploading = false;

        // Configurar drag and drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            uploadFiles(files);
        });

        fileInput.addEventListener('change', function(e) {
            uploadFiles(e.target.files);
        });

        function uploadFiles(files) {
            if (files.length === 0 || isUploading) return;
            
            isUploading = true;
            const formData = new FormData();
            
            for (let file of files) {
                formData.append('files', file);
            }

            // Mostrar progress bar
            const progressBar = document.getElementById('uploadProgress');
            const progressBarInner = progressBar.querySelector('.progress-bar');
            progressBar.style.display = 'block';
            progressBarInner.style.width = '0%';

            // Simular progresso
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressBarInner.style.width = progress + '%';
                if (progress >= 90) clearInterval(progressInterval);
            }, 100);

            fetch(`/api/agents/${agentId}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBarInner.style.width = '100%';
                
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    isUploading = false;
                    
                    if (data.success) {
                        alert(`Upload concluído! ${data.total_files} arquivo(s) carregado(s).`);
                        loadFiles();
                    } else {
                        alert('Erro no upload: ' + data.error);
                    }
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                progressBar.style.display = 'none';
                isUploading = false;
                console.error('Erro no upload:', error);
                alert('Erro no upload');
            });
        }

        function loadFiles() {
            fetch(`/api/agents/${agentId}/files`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayFiles(data.files);
                    }
                })
                .catch(error => console.error('Erro ao carregar arquivos:', error));
        }

        function displayFiles(files) {
            const container = document.getElementById('filesList');
            
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                        <p>Nenhum documento carregado</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="file-item">
                    <div>
                        <i class="fas fa-file me-2"></i>
                        <strong>${file.name}</strong>
                        <br>
                        <small class="text-muted">
                            ${(file.size / 1024).toFixed(1)} KB • 
                            ${file.modified.substring(0, 10)}
                        </small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${file.name}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteFile(filename) {
            if (!confirm(`Tem certeza que deseja deletar "${filename}"?`)) return;
            
            fetch(`/api/agents/${agentId}/files/${encodeURIComponent(filename)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadFiles();
                    alert('Arquivo deletado com sucesso!');
                } else {
                    alert('Erro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro ao deletar arquivo:', error);
                alert('Erro ao deletar arquivo');
            });
        }

        // Chat functions
        function startChat() {
            document.getElementById('chatContainer').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('chatInput').focus();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Adicionar mensagem do usuário
            addMessage(message, 'user');
            input.value = '';
            
            // Mostrar loading
            addMessage('Processando...', 'agent', true);
            
            // Enviar para API
            fetch(`/api/agents/${agentId}/query`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: message })
            })
            .then(response => response.json())
            .then(data => {
                // Remover loading
                removeLoadingMessage();
                
                if (data.success) {
                    addMessage(data.answer, 'agent');
                } else {
                    addMessage(`Erro: ${data.error}`, 'agent');
                }
            })
            .catch(error => {
                removeLoadingMessage();
                addMessage(`Erro de conexão: ${error}`, 'agent');
            });
        }

        function addMessage(text, type, loading = false) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            if (loading) messageDiv.className += ' loading';
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMessages = document.querySelectorAll('.message.loading');
            loadingMessages.forEach(msg => msg.remove());
        }

        // Configurar input de chat
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html> 